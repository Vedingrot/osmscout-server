
services:

  # download PBF and import mbox tiles using planetiler 
  planetiler:
    image: ghcr.io/onthegomap/planetiler:0.8.2
    volumes:
      - ${STORE_PLANET}:/planet_pbf
      - ${STORE_MBTILES}:/data
      - ./mapbox:/scripts_mapbox
    user: ${USER_ID}:${GROUP_ID}
    mem_limit: ${RAM_PLANETILER_LIMIT}
    entrypoint: ""
    environment:
      - PLANETILER_STORAGE_TMP=${PLANETILER_STORAGE_TMP}
      - JAVA_TOOL_OPTIONS=${JAVA_TOOL_OPTIONS}
    command: /scripts_mapbox/run_planetiler.sh /planet_pbf ${AREA}

  # prepare import to valhalla
  valhalla_prepare:
    image: alpine
    volumes:
      - ${STORE_PLANET}:/planet_pbf
      - ${STORE_VALHALLA}:/custom_files
    user: ${USER_ID}:${GROUP_ID}
    command: /bin/sh -c "rm /custom_files/*.pbf; ln -s /planet_pbf/${PBF} /custom_files"
    depends_on:
      planetiler:
        condition: service_completed_successfully

  # import to valhalla
  valhalla:
    image: ghcr.io/gis-ops/docker-valhalla/valhalla:${VALHALLA_VERSION}
    volumes:
      - ${STORE_PLANET}:/planet_pbf
      - ${STORE_VALHALLA}:/custom_files
    user: ${USER_ID}:${GROUP_ID}
    mem_limit: ${RAM_VALHALLA_LIMIT}
    environment:
      - serve_tiles=False
      - build_tar=False
      - build_admins=True
      - build_time_zones=True
      - build_transit=True
      #- build_elevation=True
    depends_on:
      valhalla_prepare:
        condition: service_completed_successfully

  # download maps
  get_nominatim_dumps:
    build:
      dockerfile: Dockerfile.wget
    volumes:
      - ${STORE_PLANET}:/planet_pbf
      - ./scripts:/scripts
    user: ${USER_ID}:${GROUP_ID}
    command: /scripts/get_urls.sh /planet_pbf/nominatim \
      https://nominatim.org/data/wikimedia-importance.sql.gz \
      https://nominatim.org/data/gb_postcodes.csv.gz \
      https://nominatim.org/data/us_postcodes.csv.gz
    depends_on:
      planetiler:
        condition: service_completed_successfully

  # import pbf to nominatim
  nominatim:
    image: mediagis/nominatim:4.4
    volumes:
      - ${STORE_PLANET}:/planet_pbf
      - ${STORE_NOMINATIM_DB}:/var/lib/postgresql/14/main
      - ${STORE_NOMINATIM_FLAT}:/nominatim/flatnode
    # this image does not support setting user ID
    shm_size: 1g
    mem_limit: ${RAM_NOMINATIM_LIMIT}
    environment:
      - PBF_PATH=/planet_pbf/${PBF}
      - REPLICATION_URL=https://ftp5.gwdg.de/pub/misc/openstreetmap/planet.openstreetmap.org/replication/hour/
      - POSTGRES_SHARED_BUFFERS=1GB
      - POSTGRES_MAINTENANCE_WORK_MEM=5GB
      - POSTGRES_AUTOVACUUM_WORK_MEM=1GB
      - POSTGRES_EFFECTIVE_CACHE_SIZE=12GB
      - NOMINATIM_PASSWORD=$NOMINATIM_PASSWORD
      - IMPORT_WIKIPEDIA=/planet_pbf/nominatim/wikimedia-importance.sql.gz
      - IMPORT_US_POSTCODES=/planet_pbf/nominatim/us_postcodes.csv.gz
      - IMPORT_GB_POSTCODES=/planet_pbf/nominatim/gb_postcodes.csv.gz
    depends_on:
      valhalla:
        condition: service_completed_successfully
      get_nominatim_dumps:
        condition: service_completed_successfully

  # wait for nominatim import to finish
  wait_for_nominatim:
    image: alpine
    volumes:
      - ./scripts:/scripts
    user: ${USER_ID}:${GROUP_ID}
    command: /scripts/wait_for_port.sh nominatim 8080
    depends_on:
      - nominatim

  # prepare valhalla tiles to postprocessing
  valhalla_tiles2packs:
    build:
      context: valhalla
      dockerfile: Dockerfile.tiles2packs
      args:
        VALHALLA_VERSION: ${VALHALLA_VERSION}
    volumes:
      - ${STORE_VALHALLA}:/custom_files
    user: ${USER_ID}:${GROUP_ID}
    depends_on:
      valhalla:
        condition: service_completed_successfully

  # postprocess mb and valhalla tiles
  # prepare for geocoder-nlp import
  postprocess:
    build:
      context: .
      dockerfile: Dockerfile.postprocess
    volumes:
      - ${STORE_PLANET}:/planet_pbf
      - ${STORE_MBTILES}:/mapbox-planet
      - ${STORE_VALHALLA}:/valhalla
      - ${STORE_IMPORTED}:/import
      - ${STORE_MISC}:/osmscout
      - ./hierarchy:/app/hierarchy
      - ./provided:/app/provided
    user: ${USER_ID}:${GROUP_ID}
    mem_limit: ${RAM_DEFALT_LIMIT}
    environment:
      GEOCODER_IMPORTER_POSTGRES: postgresql://nominatim:$NOMINATIM_PASSWORD@nominatim:5432/nominatim
      GEOCODER_JOBS: $GEOCODER_JOBS
    depends_on:
      valhalla:
        condition: service_completed_successfully
      valhalla_tiles2packs:
        condition: service_completed_successfully
      wait_for_nominatim:
        condition: service_completed_successfully
